<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard — Aura Realty</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/vistaUsuarios.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container my-5">
        <h1 class="dashboard-title">Métricas de Rendimiento</h1>

        <div style="width: 180px;" class="text-end">
            <a href="/aura-realty/aura-realty/frontend/admin/panelControl.html" class="btn btn-panel-admin btn-rounded rounded-pill">
                <i class="fa-solid fa-arrow-left me-2"></i> Volver al Panel
            </a>
        </div>
        <br>

        <div class="row g-4 mb-5 text-white">
            <div class="col-md-3">
                <div class="p-4 rounded-4 shadow-sm" style="background-color: var(--navy); border-bottom: 5px solid var(--gold);">
                    <small>Visitas Agendadas</small>
                    <h2 id="kpi-visitas" class="fw-bold">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-4 rounded-4 shadow-sm" style="background-color: var(--navy); border-bottom: 5px solid var(--gold);">
                    <small>Contratos Cerrados</small>
                    <h2 id="kpi-contratos" class="fw-bold">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-4 rounded-4 shadow-sm" style="background-color: var(--navy); border-bottom: 5px solid var(--gold);">
                    <small>% Cancelaciones</small>
                    <h2 id="kpi-canceladas" class="fw-bold">0%</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-4 rounded-4 shadow-sm" style="background-color: var(--gold); color: var(--navy);">
                    <small>Total Propiedades</small>
                    <h2 id="kpi-propiedades" class="fw-bold">0</h2>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="table-wrapper">
                    <h5 class="fw-bold mb-4" style="color: var(--navy);">Distribución por Contrato</h5>
                    <canvas id="chartContratos"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-wrapper">
                    <h5 class="fw-bold mb-4" style="color: var(--navy);">Visitas por Trabajador</h5>
                    <canvas id="chartAgentes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="/aura-realty/aura-realty/assets/js/components/navbar.js"></script>
    <script>
        async function loadDashboard() {
            const res = await fetch('/aura-realty/aura-realty/api/dashboard/metrics.php');
            const data = await res.json();

            // Actualizar KPIs
            document.getElementById('kpi-visitas').innerText = data.stats.visitas_agendadas;
            document.getElementById('kpi-contratos').innerText = data.stats.contratos_exitosos;
            document.getElementById('kpi-canceladas').innerText = data.stats.porcentaje_cancelacion + '%';

            // Gráfico de Contratos (Dona)
            new Chart(document.getElementById('chartContratos'), {
                type: 'doughnut',
                data: {
                    labels: data.graficos.por_contrato.map(i => i.tipo),
                    datasets: [{
                        data: data.graficos.por_contrato.map(i => i.cantidad),
                        backgroundColor: ['#001f3f', '#D1B16D', '#3F9FFF']
                    }]
                }
            });

            // Gráfico de Agentes (Barras)
            new Chart(document.getElementById('chartAgentes'), {
                type: 'bar',
                data: {
                    labels: data.graficos.por_agente.map(i => i.nombre),
                    datasets: [{
                        label: 'Visitas Asignadas',
                        data: data.graficos.por_agente.map(i => i.total),
                        backgroundColor: '#D1B16D'
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }
        loadDashboard();
    </script>
</body>
</html>